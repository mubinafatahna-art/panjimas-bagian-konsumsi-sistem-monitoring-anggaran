<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Konsumsi Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --primary: #0d6efd; --success: #198754; --warning: #ffc107; }
        body { background-color: #f8f9fa; font-size: 0.9rem; }
        .card-stat { border: none; border-radius: 15px; color: white; }
        .bg-gradient-blue { background: linear-gradient(45deg, #0d6efd, #00d4ff); }
        .bg-gradient-red { background: linear-gradient(45deg, #dc3545, #ff5f6d); }
        .bg-gradient-green { background: linear-gradient(45deg, #198754, #2ecc71); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4 shadow">
    <div class="container text-center">
        <span class="navbar-brand fw-bold mx-auto">PANITIA KONSUMSI - DASHBOARD</span>
    </div>
</nav>

<div class="container">
    <div class="row mb-4">
        <div class="col-md-4 mb-2">
            <div class="card card-stat bg-gradient-blue p-3 shadow-sm">
                <small>Total Anggaran</small>
                <h3 id="anggaran-total">Rp 180,000,000</h3> </div>
        </div>
        <div class="col-md-4 mb-2">
            <div class="card card-stat bg-gradient-red p-3 shadow-sm">
                <small>Dana Terpakai</small>
                <h3 id="dana-terpakai">Rp 0</h3>
            </div>
        </div>
        <div class="col-md-4 mb-2">
            <div class="card card-stat bg-gradient-green p-3 shadow-sm">
                <small>Sisa Anggaran</small>
                <h3 id="sisa-anggaran">Rp 0</h3>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow p-4">
                <h6 class="fw-bold border-bottom pb-2 mb-3">FORM PEMESANAN & NOTA</h6>
                <form id="notaForm">
                    <div class="mb-2">
                        <label class="small fw-bold">No. Pemesanan / Invoice</label>
                        <input type="text" id="noPesanan" class="form-control form-control-sm" placeholder="Contoh: KNS-001" required>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Tanggal Pesan</label>
                        <input type="date" id="tglPesan" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Anggota Tim</label>
                        <select id="nama" class="form-select form-select-sm" required>
                            <option value="Anggota 1">Fatahna</option>
                            <option value="Anggota 2">Aghea</option>
                            <option value="Anggota 3">Syauqi</option>
                            <option value="Anggota 4">Abdillah</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Item / Menu</label>
                        <input type="text" id="keperluan" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-2">
                        <label class="small fw-bold">Nominal (Rp)</label>
                        <input type="number" id="nominal" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-danger">Upload Foto Nota</label>
                        <input type="file" id="fotoNota" class="form-control form-control-sm" accept="image/*" required>
                    </div>
                    <button type="submit" id="btnKirim" class="btn btn-primary w-100 fw-bold">UPLOAD DATA</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                        <thead class="table-dark">
                            <tr>
                                <th>No. Pesan</th>
                                <th>Tgl Pesan</th>
                                <th>Nama</th>
                                <th>Nominal</th>
                                <th>Nota</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydoOs30nfBj58Io_Q598Dacul7_0dAaTNUldWYtws7aCmNl7qbeRWaOibOSu1DCSAp/exec";
    const BUDGET_AWAL = 178000000; // SILAKAN GANTI TOTAL BUDGET DI SINI

    // Proses Submit
    document.getElementById('notaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnKirim');
        const fileInput = document.getElementById('fotoNota');
        const file = fileInput.files[0];
        const reader = new FileReader();

        btn.disabled = true;
        btn.innerText = "Sedang Mengupload...";

        reader.onload = function(event) {
            const data = {
                noPesanan: document.getElementById('noPesanan').value,
                tglPesan: document.getElementById('tglPesan').value,
                nama: document.getElementById('nama').value,
                keperluan: document.getElementById('keperluan').value,
                nominal: document.getElementById('nominal').value,
                imageBlob: event.target.result
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
            .then(() => { alert('Data dan Nota Berhasil Diunggah!'); location.reload(); });
        };
        reader.readAsDataURL(file);
    });

    // Ambil Data & Hitung Sisa
    fetch(SCRIPT_URL).then(res => res.json()).then(data => {
        let html = "";
        let terpakai = 0;
        for(let i = 1; i < data.length; i++) {
            const nom = Number(data[i][5]);
            terpakai += nom;
            html += `<tr>
                <td><b>${data[i][1]}</b></td>
                <td>${data[i][2]}</td>
                <td>${data[i][3]}</td>
                <td class="text-primary fw-bold">Rp ${nom.toLocaleString()}</td>
                <td><a href="${data[i][6]}" target="_blank" class="btn btn-sm btn-outline-info p-0 px-1">Lihat</a></td>
                <td><span class="badge ${data[i][7] == 'Pending' ? 'bg-warning' : 'bg-success'}">${data[i][7]}</span></td>
            </tr>`;
        }
        document.getElementById('tabelBody').innerHTML = html;
        document.getElementById('dana-terpakai').innerText = "Rp " + terpakai.toLocaleString();
        document.getElementById('sisa-anggaran').innerText = "Rp " + (BUDGET_AWAL - terpakai).toLocaleString();
        document.getElementById('anggaran-total').innerText = "Rp " + BUDGET_AWAL.toLocaleString();
    });
</script>
</body>
</html>
